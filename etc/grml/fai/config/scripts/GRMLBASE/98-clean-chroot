#!/bin/sh
# Filename:      /etc/grml/fai/config/scripts/GRMLBASE/98-clean-chroot
# Purpose:       clean up chroot system
# Authors:       grml-team (grml.org), (c) Michael Prokop <mika@grml.org>
# Bug-Reports:   see http://grml.org/bugs/
# License:       This file is licensed under the GPL v2 or any later version.
# Latest change: Sun Dec 16 20:00:39 CET 2007 [mika]
################################################################################

set -e

# remove some big directories when using class LATEX_CLEANUP:
if ifclass LATEX_CLEANUP ; then
   cp /etc/grml/fai/grml/grml_cleanup_chroot.latex_cleanup $target/root/
   $ROOTCMD  /root/grml_cleanup_chroot.latex_cleanup
   rm $target/root/grml_cleanup_chroot.latex_cleanup
fi

# skip tasks which require only when using class NO_ONLINE:
if ! ifclass NO_ONLINE ; then
   cp /etc/grml/fai/grml/grml_cleanup_chroot.online $target/root/
   $ROOTCMD  /root/grml_cleanup_chroot.online
   rm $target/root/grml_cleanup_chroot.online
fi

# remove /usr/share/doc, /usr/share/info,... only in class REMOVE_DOCS:
if ifclass REMOVE_DOCS ; then
   cp /etc/grml/fai/grml/grml_cleanup_chroot.remove_docs $target/root/
   $ROOTCMD  /root/grml_cleanup_chroot.remove_docs
   rm $target/root/grml_cleanup_chroot.remove_docs
fi

# drop unnecessary software:
if ifclass GRML_SMALL || ifclass DEBORPHAN ; then
   if [ -f /etc/grml/fai/grml/grml_cleanup_chroot.deborphan ] ; then
      cp /etc/grml/fai/grml/grml_cleanup_chroot.deborphan $target/root/
      $ROOTCMD  /root/grml_cleanup_chroot.deborphan
      rm $target/root/grml_cleanup_chroot.deborphan
   fi
fi

# make sure to drop from grml-small what's unnecessary:
if ifclass GRML_SMALL ; then
   $ROOTCMD apt-get -y --purge remove groff-base info \
                    locales man-db manpages nano
fi

# misc cleanup:
if [ -f /etc/grml/fai/grml/grml_cleanup_chroot ] ; then
   cp /etc/grml/fai/grml/grml_cleanup_chroot $target/root/
   $ROOTCMD  /root/grml_cleanup_chroot
   rm $target/root/grml_cleanup_chroot
fi

# make sure GRML_SMALL uses the appropriate configuration:
if ifclass GRML_SMALL ; then
   cp $target/etc/inittab.small $target/etc/inittab
   cp $target/etc/runlevel.conf.livecd.small $target/etc/runlevel.conf
fi

if ifclass RELEASE ; then
   # Remove all FAI logs from chroot via grml-live later then:
   touch $target/etc/grml_fai_release
   # Remove all files inside /root/ of chroot:
   rm -rf $target/root && mkdir -m 0755 $target/root
fi

## END OF FILE #################################################################
# vim:ft=sh expandtab ai tw=80 tabstop=4 shiftwidth=3
