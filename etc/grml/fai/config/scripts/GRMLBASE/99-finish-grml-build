#!/bin/sh
# Filename:      /etc/grml/fai/config/scripts/GRMLBASE/99-finish-grml-build
# Purpose:       finalize grml chroot build
# Authors:       grml-team (grml.org), (c) Michael Prokop <mika@grml.org>
# Bug-Reports:   see http://grml.org/bugs/
# License:       This file is licensed under the GPL v2 or any later version.
# Latest change: Sat Apr 12 21:35:01 CEST 2008 [mika]
################################################################################

set -u
set -e

# Restore usual Debian behaviour which has been changed
# for FAI via /etc/grml/fai/config/hooks/instsoft.GRMLBASE
if [ -r $target/etc/apt/apt.conf ] ; then
   sed -i "s#^Acquire::http::Pipeline-Depth.*#// &#"  $target/etc/apt/apt.conf
   sed -i "s#^APT::Install-Recommends.*#// &#"        $target/etc/apt/apt.conf
   # Notice: deprecated since aptitude (0.4.11-1):
   sed -i "s#^Aptitude::Recommends-Important.*#// &#" $target/etc/apt/apt.conf
fi

# Restore original state from softupdate:
if [ -r $target/etc/policy-rc.d.conf ] ; then
   sed -i "s/EXITSTATUS='101'/EXITSTATUS='0'/" $target/etc/policy-rc.d.conf
fi

# Restore usual behaviour:
if [ -r $target/etc/kernel-img.conf ] ; then
   if grep -q "silent_modules = Yes" $target/etc/kernel-img.conf ; then
      sed -i "s/silent_modules = Yes/# &/" $target/etc/kernel-img.conf
   fi
fi

# remove an existing /etc/debian_chroot file:
if [ -r $target/etc/debian_chroot ] ; then
   rm -f $target/etc/debian_chroot
fi

# /etc/grml_cd makes the live system recognizable as a live system
touch $target/etc/grml_cd

## END OF FILE #################################################################
# vim:ft=sh expandtab ai tw=80 tabstop=4 shiftwidth=3
